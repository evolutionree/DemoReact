<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <link rel="stylesheet" href="mobilecrm.css" />
  <script src="//g.alicdn.com/dingding/dingtalk-jsapi/2.0.57/dingtalk.open.js"></script>
  <title>Uå®¢CRM</title>
</head>
<body>
<div id="root" style="width: 100%;height: 100%"></div>
<script>
  if(!window.localStorage.getItem("userId")){
    if(dd){
      dd.ready(function () {
        dd.runtime.permission.requestAuthCode({
          corpId: 'dingc464c1bcba24669335c2f4657eb6378f',
          onSuccess: function (info) {
              alert(info.code);
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("post", "api/dingding/loginwithdingtalk", false);
            xmlHttp.setRequestHeader('Content-Type', 'application/json');
            xmlHttp.onreadystatechange = function () {
                alert('onreadystatechange:' + xmlHttp.readyState)
              if(xmlHttp.readyState==4){
                if(xmlHttp.status==200){
                    alert(1)
                  alert(xmlHttp.responseText)
                  //loadJs();

                }else{
                  alert("load fail:"+xmlHttp.status);
                }
              }
            };

            xmlHttp.send(JSON.stringify({ code: info.code }));
          },
          onFail: function (err) {
            alert('requestAuthCode fail: ' + JSON.stringify(err));
          }
        });
      });
    }else{
      loadJs();
    }
  }else{
    loadJs();
  }



  function loadJs(){
//    var commScript = document.createElement("script");
//
//    commScript.onload = function(){
//      var pageScript = document.createElement("script");
//      pageScript.src = "js/app.js?rad="+Math.random();
//      document.body.appendChild(pageScript);
//    }
//
//    commScript.src = "js/common.js?rad="+Math.random();
//    document.body.appendChild(commScript);
  }
</script>
<script src="mobilecrm.js"></script>
</body>
</html>
